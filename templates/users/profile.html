{% extends 'base.html' %}

{% block title %}Profile - Karyo{% endblock %}

{% block content %}
<div class="bg-notebook-bg pb-20 sm:pb-4">
    <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto pt-4 sm:pt-6">
            <!-- Profile Completion Progress Bar -->
            <div class="mb-5 sm:mb-6">
                <div class="flex justify-between items-center mb-1.5">
                    <h2 class="text-sm sm:text-base text-gray-900 font-semibold">Profile Completion</h2>
                    <span class="text-sm sm:text-base text-black font-bold">{{ completion_percentage }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-500"
                        style="width: {{ completion_percentage }}%"></div>
                </div>
            </div>

            <form method="post" id="profile-form"
                class="bg-white rounded-xl shadow-sm p-5 sm:p-8 border border-gray-200">
                {% csrf_token %}

                <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-6">Profile Information</h2>

                <div class="grid grid-cols-2 gap-x-4 gap-y-5 sm:gap-x-6 sm:gap-y-6 sm:grid-cols-6">

                    <!-- Full Name -->
                    <div class="col-span-2 sm:col-span-3">
                        <label for="{{ form.full_name.id_for_label }}"
                            class="block text-sm font-medium leading-5 text-gray-900">Full Name</label>
                        <div class="mt-1 sm:mt-2">
                            {{ form.full_name }}
                            {% if form.full_name.errors %}
                            <p class="text-red-600 text-xs mt-1">{{ form.full_name.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Email -->
                    <div class="col-span-2 sm:col-span-3">
                        <label for="{{ form.email.id_for_label }}"
                            class="block text-sm font-medium leading-5 text-gray-900">Email</label>
                        <div class="mt-1 sm:mt-2">
                            {{ form.email }}
                            {% if form.email.errors %}
                            <p class="text-red-600 text-xs mt-1">{{ form.email.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Mobile (side by side with Gender on mobile) -->
                    <div class="col-span-1 sm:col-span-3">
                        <label for="{{ form.mobile.id_for_label }}"
                            class="block text-sm font-medium leading-5 text-gray-900">Mobile</label>
                        <div class="mt-1 sm:mt-2">
                            {{ form.mobile }}
                            {% if form.mobile.errors %}
                            <p class="text-red-600 text-xs mt-1">{{ form.mobile.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Gender (side by side with Mobile on mobile) -->
                    <div class="col-span-1 sm:col-span-3" x-data="{ 
                        open: false, 
                        selected: '{{ user.gender|default:'' }}',
                        options: [
                            { value: '', label: '---------' },
                            { value: 'Male', label: 'Male' },
                            { value: 'Female', label: 'Female' },
                            { value: 'Other', label: 'Other' }
                        ],
                        get selectedLabel() {
                            const option = this.options.find(o => o.value === this.selected);
                            return option ? option.label : '---------';
                        }
                    }">
                        <label class="block text-sm font-medium leading-5 text-gray-900">Gender</label>
                        <div class="mt-1 sm:mt-2 relative">
                            <!-- Hidden input for form submission -->
                            <input type="hidden" name="gender" :value="selected">

                            <!-- Custom dropdown button -->
                            <button type="button" @click="open = !open" @click.outside="open = false"
                                class="w-full rounded-md border-0 py-1.5 px-2 sm:px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 text-sm leading-6 bg-white cursor-pointer text-left flex items-center justify-between">
                                <span x-text="selectedLabel" class="truncate"></span>
                                <svg class="h-4 w-4 sm:h-5 sm:w-5 text-gray-400 flex-shrink-0" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>

                            <!-- Dropdown options -->
                            <div x-show="open" x-transition:enter="transition ease-out duration-100"
                                x-transition:enter-start="transform opacity-0 -translate-y-2"
                                x-transition:enter-end="transform opacity-100 translate-y-0"
                                x-transition:leave="transition ease-in duration-75"
                                x-transition:leave-start="transform opacity-100 translate-y-0"
                                x-transition:leave-end="transform opacity-0 -translate-y-2"
                                class="absolute z-10 w-full mt-1 bg-white rounded-md shadow-lg ring-1 ring-inset ring-gray-300 max-h-60 overflow-y-auto">
                                <template x-for="option in options" :key="option.value">
                                    <div @click="selected = option.value; open = false"
                                        :class="selected === option.value ? 'bg-indigo-50 text-indigo-600' : 'text-gray-900 hover:bg-gray-100'"
                                        class="px-3 py-2 cursor-pointer text-sm">
                                        <span x-text="option.label"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                        {% if form.gender.errors %}
                        {% endif %}
                    </div>

                    <!-- State (side by side with City on mobile) -->
                    <div class="col-span-1 sm:col-span-3">
                        <label for="{{ form.state.id_for_label }}"
                            class="block text-sm font-medium leading-5 text-gray-900">State</label>
                        <div class="mt-1 sm:mt-2 relative">
                            <input type="text" id="state-search"
                                class="block w-full rounded-md border-0 py-1.5 px-2 sm:px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 text-sm leading-6"
                                placeholder="Search..." value="{{ user.state.name|default:'' }}">
                            {{ form.state }}
                            <div id="state-results"
                                class="absolute z-10 w-full bg-white border border-gray-200 rounded-md mt-1 hidden max-h-60 overflow-y-auto shadow-lg">
                            </div>
                        </div>
                    </div>

                    <!-- City (side by side with State on mobile) -->
                    <div class="col-span-1 sm:col-span-3">
                        <label for="{{ form.city.id_for_label }}"
                            class="block text-sm font-medium leading-5 text-gray-900">City</label>
                        <div class="mt-1 sm:mt-2 relative">
                            <input type="text" id="city-search"
                                class="block w-full rounded-md border-0 py-1.5 px-2 sm:px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 text-sm leading-6"
                                placeholder="Search..." value="{{ user.city.name|default:'' }}">
                            {{ form.city }}
                            <div id="city-results"
                                class="absolute z-10 w-full bg-white border border-gray-200 rounded-md mt-1 hidden max-h-60 overflow-y-auto shadow-lg">
                            </div>
                        </div>
                    </div>

                    <!-- College (full width on mobile) -->
                    <div class="col-span-2 sm:col-span-3">
                        <label for="{{ form.college.id_for_label }}"
                            class="block text-sm font-medium leading-5 text-gray-900">College</label>
                        <div class="mt-1 sm:mt-2 relative">
                            <input type="text" id="college-search"
                                class="block w-full rounded-md border-0 py-1.5 px-2 sm:px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 text-sm leading-6"
                                placeholder="Search College..." value="{{ user.college.name|default:'' }}">
                            {{ form.college }}
                            <div id="college-results"
                                class="absolute z-10 w-full bg-white border border-gray-200 rounded-md mt-1 hidden max-h-60 overflow-y-auto shadow-lg">
                            </div>
                        </div>
                    </div>

                    <!-- Branch (full width on mobile) -->
                    <div class="col-span-2 sm:col-span-3">
                        <label for="{{ form.branch.id_for_label }}"
                            class="block text-sm font-medium leading-5 text-gray-900">Branch</label>
                        <div class="mt-1 sm:mt-2 relative">
                            <input type="text" id="branch-search"
                                class="block w-full rounded-md border-0 py-1.5 px-2 sm:px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 text-sm leading-6"
                                placeholder="Search Branch..." value="{{ user.branch.name|default:'' }}">
                            {{ form.branch }}
                            <div id="branch-results"
                                class="absolute z-10 w-full bg-white border border-gray-200 rounded-md mt-1 hidden max-h-60 overflow-y-auto shadow-lg">
                            </div>
                        </div>
                    </div>

                    <!-- Degree (after branch) -->
                    <div class="col-span-2 sm:col-span-3">
                        <label for="degree-search"
                            class="block text-sm font-medium leading-5 text-gray-900">Degree</label>
                        <div class="mt-1 sm:mt-2 relative">
                            <input type="text" id="degree-search"
                                class="block w-full rounded-md border-0 py-1.5 px-2 sm:px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 text-sm leading-6"
                                placeholder="Search Degree..."
                                value="{% if user.degree %}{{ user.degree.name }} - {{ user.degree.full_name }}{% endif %}">
                            {{ form.degree }}
                            <div id="degree-results"
                                class="absolute z-10 w-full bg-white border border-gray-200 rounded-md mt-1 hidden max-h-60 overflow-y-auto shadow-lg">
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Desktop buttons (hidden on mobile) -->
                <div class="hidden sm:flex items-center justify-end gap-x-6 mt-6">
                    <a href="/" class="text-sm font-semibold text-gray-900 hover:text-gray-700">Cancel</a>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md font-medium hover:bg-blue-700 transition-all flex items-center gap-2 text-sm">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mobile sticky bottom buttons -->
    <div
        class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-4 flex items-center justify-center gap-x-4 z-20 sm:hidden">
        <a href="/"
            class="flex-1 max-w-[140px] text-center py-2.5 border-2 border-gray-300 rounded-lg text-base font-semibold text-gray-700 hover:bg-gray-50 transition-all">Cancel</a>
        <button type="submit" form="profile-form"
            class="flex-1 max-w-[140px] py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-all text-base">Save</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // Hide actual selects
        $('#id_college, #id_branch, #id_degree, #id_state, #id_city').hide();

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        function setupSearch(inputId, resultsId, hiddenSelectId, url, paramName = 'q', extraParams = () => ({})) {
            function fetchResults(query = '') {
                let data = {};
                data[paramName] = query;
                Object.assign(data, extraParams());

                $.ajax({
                    url: url,
                    data: data,
                    success: function (response) {
                        let html = '';
                        if (response.length > 0) {
                            response.forEach(item => {
                                html += `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-900" data-id="${item.id}">${item.name}</div>`;
                            });
                            $(resultsId).html(html).removeClass('hidden');
                        } else {
                            $(resultsId).html('<div class="px-4 py-2 text-gray-500">No results found</div>').removeClass('hidden');
                        }
                    }
                });
            }

            const debouncedFetch = debounce(function () {
                const val = $(this).val();
                if (val.length >= 3) {
                    fetchResults(val);
                } else if (val.length === 0) {
                    fetchResults('');
                } else {
                    $(resultsId).addClass('hidden');
                }
            }, 300);

            $(inputId).on('input', debouncedFetch);

            $(inputId).on('focus', function () {
                const val = $(this).val();
                if (val.length === 0) {
                    fetchResults('');
                } else if (val.length >= 3) {
                    fetchResults(val);
                }
            });

            $(document).on('click', resultsId + ' div', function () {
                const text = $(this).text();
                const id = $(this).data('id');
                if (id) {
                    $(inputId).val(text);
                    $(hiddenSelectId).val(id);
                    $(resultsId).addClass('hidden');

                    // Trigger change for dependent fields
                    if (hiddenSelectId === '#id_state') {
                        $('#city-search').val('');
                        $('#id_city').val('');
                    }
                }
            });

            // Close results when clicking outside
            $(document).on('click', function (e) {
                if (!$(e.target).closest(inputId).length && !$(e.target).closest(resultsId).length) {
                    $(resultsId).addClass('hidden');
                }
            });
        }

        setupSearch('#college-search', '#college-results', '#id_college', '/core/api/colleges/');
        setupSearch('#branch-search', '#branch-results', '#id_branch', '/core/api/branches/');
        setupSearch('#degree-search', '#degree-results', '#id_degree', '/auth/search-degrees/');
        setupSearch('#state-search', '#state-results', '#id_state', '/core/api/states/');
        setupSearch('#city-search', '#city-results', '#id_city', '/core/api/cities/', 'q', function () {
            return { state_id: $('#id_state').val() };
        });
    });
</script>
{% endblock %}