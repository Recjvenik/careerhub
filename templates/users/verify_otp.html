{% extends 'base.html' %}

{% block content %}
<div class="min-h-[80vh] flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-2xl border border-gray-100 shadow-sm">
        <div class="text-center">
            <h2 class="text-3xl font-bold text-gray-900">
                {% if verification_type == 'registration' %}Verify Mobile Number{% else %}Identity Verification{% endif %}
            </h2>
            <p class="mt-2 text-sm text-gray-600">
                {% if verification_type == 'registration' %}
                    Click below to verify your mobile number
                {% elif '@' in reset_identifier %}
                    Verify your email address to reset password
                {% else %}
                    Verify your mobile number to reset password
                {% endif %}
            </p>
        </div>

        {% if messages %}
        <div class="space-y-2">
            {% for message in messages %}
            <div class="{% if message.tags == 'error' %}bg-red-50 text-red-600{% else %}bg-green-50 text-green-600{% endif %} p-4 rounded-lg text-sm">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div id="verification-container" class="mt-8 flex justify-center">
            {% if verification_type == 'registration' or '@' not in reset_identifier %}
                <!-- Mobile Verification -->
                <div class="pe_signin_button" data-client-id="{{ client_id }}">
                    <script src="https://www.phone.email/sign_in_button_v1.js" async></script>
                </div>
            {% else %}
                <!-- Email Verification -->
                <div class="pe_verify_email" data-client-id="{{ client_id }}">
                    <script src="https://www.phone.email/verify_email_v1.js" async></script>
                </div>
            {% endif %}
        </div>

        <div id="status-message" class="hidden text-center mt-4 p-4 rounded-lg"></div>

        <div class="text-center mt-6">
            <a href="{% if verification_type == 'registration' %}{% url 'register' %}{% else %}{% url 'forgot_password' %}{% endif %}" 
               class="text-sm font-medium text-blue-600 hover:text-blue-500">
               Go back
            </a>
        </div>
    </div>
</div>

<script>
function handleVerification(userObj) {
    const user_json_url = userObj.user_json_url;
    const statusMsg = document.getElementById('status-message');
    
    // Show loading state
    statusMsg.classList.remove('hidden', 'bg-red-50', 'text-red-600', 'bg-green-50', 'text-green-600');
    statusMsg.classList.add('bg-blue-50', 'text-blue-600');
    statusMsg.innerText = "Verifying with our servers...";

    // Send to backend
    fetch(`/auth/phone-email-callback/?user_json_url=${encodeURIComponent(user_json_url)}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                statusMsg.classList.remove('bg-blue-50', 'text-blue-600');
                statusMsg.classList.add('bg-green-50', 'text-green-600');
                statusMsg.innerText = "Verification successful! Redirecting...";
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 1000);
            } else {
                statusMsg.classList.remove('bg-blue-50', 'text-blue-600');
                statusMsg.classList.add('bg-red-50', 'text-red-600');
                statusMsg.innerText = data.message || "Verification failed. Please try again.";
            }
        })
        .catch(error => {
            console.error('Error:', error);
            statusMsg.classList.remove('bg-blue-50', 'text-blue-600');
            statusMsg.classList.add('bg-red-50', 'text-red-600');
            statusMsg.innerText = "An error occurred. Please try again later.";
        });
}

// Phone Email Listener for Mobile
function phoneEmailListener(userObj) {
    handleVerification(userObj);
}

// Phone Email Receiver for Email
function phoneEmailReceiver(userObj) {
    handleVerification(userObj);
}
</script>
{% endblock %}